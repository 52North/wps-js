<!DOCTYPE html>
<html>
<head>
<script src="../../js/jquery/jquery.1.8.3.min.js"></script>
<script src="../../js/jquery/jquery-ui.1.8.3.min.js"></script>
<script src="../../js/openlayers/OpenLayers-closure.js"></script>
<script src="../../js/wps-js/wps-js.${project.version}.js"></script>
<link type="text/css" rel="stylesheet" href="../../css/wps-js.css">
<title>GECA dataset intercomparison - GeoViQua</title>
<link rel="shortcut icon" href="../../favicon.ico" />
</head>
<body>
	<div id="wrapper">
		<div>
			<h3>Excecute Process</h3>
			<div class="wps-container">
				<div class="wps-execute-container" id="wps-form"></div>
			</div>
			<p></p>
			<div class="wps-container">
				<div id="executeProcess"></div>
			</div>
		</div>
	</div>
	<script type="text/javascript">
	
	var RESOLVE_DATASET_TEMPLATE = '<gi:ResolveDataset xmlns:gi="http://schema.geoviqua.org/geca/0.1/intercomparison" xmlns:xlink="http://www.w3.org/1999/xlink">\n\
	   <gi:DatasetIdentifier>${identifier}</gi:DatasetIdentifier>\n\
	   ${onlineResources}\
	</gi:ResolveDataset>';
	
	var ONLINE_RESOURCE_TEMPLATE = '<gi:OnlineResource xlink:href="${resourceUrl}" />\n';
	
		function prepareDatasetMappings() {
			var result = {};
			result["fdd05b42-07e1-44b4-aa7f-8c7c82060fe3"] = "SCI_OL__2P";
			result["6c49348c-c4c1-4603-babb-880f8b7919a3"] = "ERS_GOM_LVL21";
			return result;
		}
		
		function prepareOnlineResourceMappings() {
			var result = {};
			result["SCI_OL__2P"] = ["http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_011045_000033252037_00332_16919_3757.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_025121_000033122037_00333_16920_3747.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_043157_000033252037_00334_16921_3716.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_061233_000033122037_00335_16922_3866.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_075308_000033252037_00336_16923_3696.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_093344_000033122037_00337_16924_3796.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_111420_000033252037_00338_16925_3550.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_125455_000033122037_00339_16926_3775.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_143531_000033252037_00340_16927_3862.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_161607_000033122037_00341_16928_3833.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_175629_000033032037_00342_16929_3790.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_193638_000033682037_00343_16930_3597.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_211754_000033252037_00344_16931_4399.N1",
			                        "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/SCI_OL__2P/SCI_OL__2PRDPA20050526_225830_000033122037_00345_16932_3892.N1"];
			result["ERS_GOM_LVL21"] = ["http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526000439_005_ERS2_52790_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526014510_027_ERS2_52791_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526032547_026_ERS2_52792_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526050623_003_ERS2_52793_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526064700_017_ERS2_52794_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526083328_021_ERS2_52795_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526101309_025_ERS2_52796_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526115239_026_ERS2_52797_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526133137_013_ERS2_52798_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526151027_031_ERS2_52799_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526165034_028_ERS2_52800_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526183230_007_ERS2_52801_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526201147_011_ERS2_52802_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526215223_007_ERS2_52803_DLR_05.LV2",
			                           "http://geoviqua.stcorp.nl/geca/SCI_OL__2P_vs_GOME_LVL21/GOME_LVL21/GOME_O3-NO2_L2_20050526233300_006_ERS2_52804_DLR_05.LV2"];
			return result;
		}
		
		function getUrlVar(key) {
			var input = window.location.search;
			var regex = new RegExp(key + "=([^&]*)", "ig");
			var result = [];
			var i = 0;
			var match;
			while ( ( match = regex.exec(input) ) != null ) {
				result.push(unescape(match[1])); 
			}
			return result;
		}
		
		function datasetNotSupported(id) {
			alert("Dataset '"+id+"' is not supported.");
		}
		
		function invalidDatasets() {
			alert("The provided datasets are not available or insufficient.");
		}
		
		//var wps = "http://localhost:8080/wps/WebProcessingService",
		//var wps = "http://geoviqua.dev.52north.org/wps/WebProcessingService",
		var wps, capabilities, // the capabilities, read by Format.WPSCapabilities::read
		process; // the process description from Format.WPSDescribeProcess::read

		$('#wpscaller').click(function() {
			$('#capabilitiesByClick').wpsCall({
				url : wps,
				requestType : GET_CAPABILITIES_TYPE
			});
		});
		$(document).ready(function() {
			$.wpsSetup({
				proxy : {
					url : "/wps_proxy/wps_proxy?url=",
					type : "parameter"
				},
				configuration : {
					url : "http://geoviqua.stcorp.nl/wps"
				}
			});
			
			var ids = getUrlVar("_pdPortlet_WAR_geoportal_uuid");
			var identifierToDatasetMap = prepareDatasetMappings();
			var onlineResourceMapping = prepareOnlineResourceMappings();
			
			var finalMappings = {};
			
			//check if the datasets are supported
			
			if (!ids || ids.length < 2) {
				invalidDatasets();
				return;
			}
			for (var i = 0; i < ids.length; i++) {
				var elem = ids[i];
				if (!identifierToDatasetMap[elem]) {
					datasetNotSupported(elem);
					return;
				}
			}
			var params = prepareExecuteParameters(createPredefinedValues(identifierToDatasetMap, onlineResourceMapping));
			setupWPSForm(params);
		});
		
		function createPredefinedValues(identifierToDatasetMap, onlineResourceMapping) {
			var complexInputs = createComplexInputs(identifierToDatasetMap, onlineResourceMapping);
			var result = [{"name":"deltaPosition", "value":"200000"},
			        {"name":"deltaTime", "value":"PT1H"},
			        {"name":"comparisonType", "value":""},
			        {"name":"startTime", "value":"2010-09-01T00:00:00"},
			        {"name":"boundingBox", "value":"-60, 4, 52, 5.3"},
			        {"name":"endTime", "value":"2010-10-01T00:00:00"},
			        {"name":"type", "value":"ozone"},
			        {"name":"quantity", "value":"column"},
			        {"name":"comparisonType", "value":"intercomparison"}
			]
			
			if (complexInputs) {
				var i = 1;
				for ( var ci in complexInputs) {
					result.push({"name":"dataset"+i, "value":complexInputs[ci]})
					i++;
				}
			}
			
			return result;
		}
		
		function createComplexInputs(identifierToDatasetMap, onlineResourceMapping) {
			var result = [];
			for ( var id in identifierToDatasetMap) {
				var list = onlineResourceMapping[identifierToDatasetMap[id]];
				
				var onlineList = "";
				for (var j = 0; j < list.length; j++) {
					var res = list[j];
					onlineList += fillXMLTemplate(ONLINE_RESOURCE_TEMPLATE, {resourceUrl: res});
				}
				
				result.push(fillXMLTemplate(RESOLVE_DATASET_TEMPLATE, {identifier: identifierToDatasetMap[id],
					onlineResources: onlineList}));				
			}
			
			return result;
		}

		function setupWPSForm(params) {
// 			var wpsUrl = "http://geoviqua.stcorp.nl/wps";
// 			var processIdentifier = "org.geoviqua.data.intercomparison";
// 			describeProcess(processIdentifier, wpsUrl, "wps-form");
			
            var formBuilder = new FormBuilder();
            formBuilder.clearForm(jQuery('#wps-form'));
            formBuilder.buildExecuteForm(jQuery('#wps-form'), params, execute);
		}
		
		function setParameterValue(dataInputs, preDef) {
			for (var i = 0; i < dataInputs.length; i++) {
				var di = dataInputs[i];
				
				if (equalsString(di.identifier, preDef.name)) {
					di["predefinedValue"] = preDef.value;
				}
			}
		}
		
		function prepareExecuteParameters(predefinedValues) {
			var result = {
					   "processVersion":"1.0",
					   "statusSupported":true,
					   "storeSupported":true,
					   "identifier":"org.geoviqua.data.intercomparison",
					   "title":"GECA-Intercomparison",
					   "abstract":"GECA Satellite Data Intercomparison.",
					   "dataInputs":[
					      {
					         "maxOccurs":1,
					         "minOccurs":1,
					         "identifier":"dataset1",
					         "title":"Dataset 1",
					         "abstract":"The first dataset for the intercomparison",
					         "complexData":{
					            "default":{
					               "formats":[
					                  {
					                     "mimeType":"text/xml",
					                     "schema":"http://schema.geoviqua.org/geca/0.1/resolvableDataset.xsd"
					                  }
					               ]
					            },
					            "supported":{
					               "formats":[
					                  {
					                     "mimeType":"text/xml",
					                     "schema":"http://schema.geoviqua.org/geca/0.1/resolvableDataset.xsd"
					                  }
					               ]
					            }
					         }
					      },
					      {
					         "maxOccurs":1,
					         "minOccurs":1,
					         "identifier":"dataset2",
					         "title":"Dataset 2",
					         "abstract":"The first dataset for the intercomparison",
					         "complexData":{
					            "default":{
					               "formats":[
					                  {
					                     "mimeType":"text/xml",
					                     "schema":"http://schema.geoviqua.org/geca/0.1/resolvableDataset.xsd"
					                  }
					               ]
					            },
					            "supported":{
					               "formats":[
					                  {
					                     "mimeType":"text/xml",
					                     "schema":"http://schema.geoviqua.org/geca/0.1/resolvableDataset.xsd"
					                  }
					               ]
					            }
					         }
					      },
					      {
					         "maxOccurs":1,
					         "minOccurs":0,
					         "identifier":"deltaPosition",
					         "title":"Delta Position",
					         "abstract":"The maximum spacial offset between both datasets in meters",
					         "literalData":{
					            "dataType":"string",
					            "anyValue":true
					         }
					      },
					      {
					         "maxOccurs":1,
					         "minOccurs":0,
					         "identifier":"deltaTime",
					         "title":"Delta Time",
					         "abstract":"The maximum time offset between both datasets in hours",
					         "literalData":{
					            "dataType":"string",
					            "anyValue":true
					         }
					      },
					      {
					         "maxOccurs":1,
					         "minOccurs":1,
					         "identifier":"comparisonType",
					         "title":"Comparison Type",
					         "abstract":"The comparison type (intercomparison or collocation)",
					         "literalData":{
					            "dataType":"string",
					            "allowedValues":{
					               "intercomparison":true,
					               "collocation":true
					            }
					         }
					      },
					      {
					         "maxOccurs":1,
					         "minOccurs":1,
					         "identifier":"startTime",
					         "title":"Start Time",
					         "abstract":"start time for the datasets",
					         "literalData":{
					            "dataType":"string",
					            "anyValue":true
					         }
					      },
					      {
					         "maxOccurs":1,
					         "minOccurs":1,
					         "identifier":"boundingBox",
					         "title":"Bounding Box",
					         "abstract":"geolocation for the datasets",
					         "boundingBoxData":{
					            "default":{
					               "CRSs":{
					                  "EPSG:4326":true
					               }
					            },
					            "supported":{
					               "CRSs":{
					                  "EPSG:4326":true
					               }
					            }
					         }
					      },
					      {
					         "maxOccurs":1,
					         "minOccurs":1,
					         "identifier":"endTime",
					         "title":"End Time",
					         "abstract":"end time for the datasets",
					         "literalData":{
					            "dataType":"string",
					            "anyValue":true
					         }
					      },
					      {
					         "maxOccurs":1,
					         "minOccurs":1,
					         "identifier":"type",
					         "title":"Type",
					         "abstract":"The type of the species",
					         "literalData":{
					            "dataType":"string",
					            "anyValue":true
					         }
					      },
					      {
					         "maxOccurs":1,
					         "minOccurs":1,
					         "identifier":"quantity",
					         "title":"Quantity",
					         "abstract":"The quantity of the species",
					         "literalData":{
					            "dataType":"string",
					            "anyValue":true
					         }
					      }
					   ],
					   "processOutputs":[
					      {
					         "identifier":"report",
					         "title":"Report",
					         "abstract":"The intercomparison report",
					         "selected": true,
					         "complexOutput":{
					            "default":{
					               "formats":[
					                  {
					                     "mimeType":"application/pdf"
					                  }
					               ]
					            },
					            "supported":{
					               "formats":[
					                  {
					                     "mimeType":"application/pdf"
					                  },
					                  {
					                     "mimeType":"application/zip"
					                  }
					               ]
					            }
					         }
					      }
					   ]
					};
			
			for (var i = 0; i < predefinedValues.length; i++) {
				var preDef = predefinedValues[i];
				
				setParameterValue(result.dataInputs, preDef);
			}
			
			return result;
		}
		
		
	</script>

	<div>
		<p class="infotext">${project.build.finalName} #${build-commit-abbrev} as of ${build-tstamp}, build at ${buildTimestamp}</p>
	</div>
</body>
</html>
